{
  "nodes": [
    {
      "parameters": {},
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "none",
        "operation": "sendText",
        "chatId": "={{ $json.chatId }}",
        "text": "Ch√†o b·∫°n! T√¥i l√† Pioneer Bot. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m tin t·ª©c h√†ng ƒë·∫ßu v√† b√†i vi·∫øt c·ªßa chuy√™n gia. H√£y s·ª≠ d·ª•ng c√°c l·ªánh sau:\n\n/news - Xem tin t·ª©c h√†ng ƒë·∫ßu\n/news_keyword [t·ª´ kh√≥a] - T√¨m tin t·ª©c theo t·ª´ kh√≥a\n/expert [t·ª´ kh√≥a] - T√¨m b√†i vi·∫øt chuy√™n gia theo t·ª´ kh√≥a\n/expert_content [n·ªôi dung] - T√¨m b√†i vi·∫øt chuy√™n gia t∆∞∆°ng t·ª± v·ªõi n·ªôi dung",
        "additionalFields": {}
      },
      "name": "Telegram: Send Welcome Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        700,
        100
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/start"
            }
          ]
        }
      },
      "name": "Start Command",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/news"
            }
          ]
        }
      },
      "name": "News Command",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/expert"
            }
          ]
        }
      },
      "name": "Expert Command",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        700,
        500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/news_keyword"
            }
          ]
        }
      },
      "name": "News Keyword Command",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        940,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/expert_content"
            }
          ]
        }
      },
      "name": "Expert Content Command",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        940,
        500
      ]
    },
    {
      "parameters": {
        "url": "http://localhost:8001/news/top3",
        "options": {}
      },
      "name": "Get Top News",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1180,
        200
      ]
    },
    {
      "parameters": {
        "functionCode": "// L·∫•y t·ª´ kh√≥a t·ª´ l·ªánh\nconst message = items[0].json.message.text;\nconst keyword = message.replace('/news_keyword', '').trim();\n\nif (!keyword) {\n  return [{json: {\n    chatId: items[0].json.message.chat.id,\n    error: true,\n    errorMessage: 'Vui l√≤ng cung c·∫•p t·ª´ kh√≥a. V√≠ d·ª•: /news_keyword Trump'\n  }}];\n}\n\nreturn [{\n  json: {\n    chatId: items[0].json.message.chat.id,\n    keyword: keyword\n  }\n}];"
      },
      "name": "Extract News Keyword",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1180,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "// L·∫•y t·ª´ kh√≥a t·ª´ l·ªánh\nconst message = items[0].json.message.text;\nconst keyword = message.replace('/expert', '').trim();\n\nif (!keyword) {\n  return [{json: {\n    chatId: items[0].json.message.chat.id,\n    error: true,\n    errorMessage: 'Vui l√≤ng cung c·∫•p t·ª´ kh√≥a. V√≠ d·ª•: /expert Trump'\n  }}];\n}\n\nreturn [{\n  json: {\n    chatId: items[0].json.message.chat.id,\n    keyword: keyword\n  }\n}];"
      },
      "name": "Extract Expert Keyword",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1180,
        400
      ]
    },
    {
      "parameters": {
        "functionCode": "// L·∫•y n·ªôi dung t·ª´ l·ªánh\nconst message = items[0].json.message.text;\nconst content = message.replace('/expert_content', '').trim();\n\nif (!content) {\n  return [{json: {\n    chatId: items[0].json.message.chat.id,\n    error: true,\n    errorMessage: 'Vui l√≤ng cung c·∫•p n·ªôi dung. V√≠ d·ª•: /expert_content This is an article about economy'\n  }}];\n}\n\nreturn [{\n  json: {\n    chatId: items[0].json.message.chat.id,\n    content: content\n  }\n}];"
      },
      "name": "Extract Expert Content",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1180,
        500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Check News Keyword Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1400,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Check Expert Keyword Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1400,
        400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.error }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Check Expert Content Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1400,
        500
      ]
    },
    {
      "parameters": {
        "authentication": "none",
        "operation": "sendText",
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.errorMessage }}",
        "additionalFields": {}
      },
      "name": "Send Error Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1620,
        400
      ]
    },
    {
      "parameters": {
        "url": "http://localhost:8001/news/top3?keywords={{ $json.keyword }}",
        "options": {}
      },
      "name": "Get News By Keyword",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1620,
        300
      ]
    },
    {
      "parameters": {
        "url": "http://localhost:8001/expert/expert-posts?keywords={{ $json.keyword }}&days=10&limit=5",
        "options": {}
      },
      "name": "Get Expert Posts By Keyword",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1620,
        500
      ]
    },
    {
      "parameters": {
        "url": "http://localhost:8001/expert/expert-posts?content={{ $encodeURIComponent($json.content) }}&days=10&limit=5",
        "options": {}
      },
      "name": "Get Expert Posts By Content",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1620,
        600
      ]
    },
    {
      "parameters": {
        "functionCode": "// Format tin t·ª©c th√†nh vƒÉn b·∫£n\nconst articles = items[0].json;\nlet message = 'üì∞ *TIN T·ª®C H√ÄNG ƒê·∫¶U*\n\n';\n\nif (articles.length === 0) {\n  message += 'Kh√¥ng t√¨m th·∫•y tin t·ª©c n√†o.';\n} else {\n  articles.forEach((article, index) => {\n    message += `*${index + 1}. ${article.title}*\n`;\n    message += `üìù ${article.summary.substring(0, 150)}...\n`;\n    message += `üîó [ƒê·ªçc th√™m](${article.link})\n`;\n    message += `üìä ƒêi·ªÉm: ${article.score.toFixed(2)}\n`;\n    if (article.reason) {\n      message += `üí° ${article.reason}\n`;\n    }\n    message += '\n';\n  });\n}\n\nreturn [{\n  json: {\n    chatId: items[0].json.message.chat.id,\n    message: message\n  }\n}];"
      },
      "name": "Format News",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1840,
        200
      ]
    },
    {
      "parameters": {
        "functionCode": "// Format tin t·ª©c theo t·ª´ kh√≥a th√†nh vƒÉn b·∫£n\nconst articles = items[0].json;\nlet message = `üì∞ *TIN T·ª®C V·ªÄ "${items[0].json.keyword}"*\n\n`;\n\nif (articles.length === 0) {\n  message += 'Kh√¥ng t√¨m th·∫•y tin t·ª©c n√†o ph√π h·ª£p v·ªõi t·ª´ kh√≥a.';\n} else {\n  articles.forEach((article, index) => {\n    message += `*${index + 1}. ${article.title}*\n`;\n    message += `üìù ${article.summary.substring(0, 150)}...\n`;\n    message += `üîó [ƒê·ªçc th√™m](${article.link})\n`;\n    message += `üìä ƒêi·ªÉm: ${article.score.toFixed(2)}\n`;\n    if (article.reason) {\n      message += `üí° ${article.reason}\n`;\n    }\n    message += '\n';\n  });\n}\n\nreturn [{\n  json: {\n    chatId: items[0].json.chatId || items[0].json.message.chat.id,\n    message: message\n  }\n}];"
      },
      "name": "Format News By Keyword",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1840,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "// Format b√†i ƒëƒÉng chuy√™n gia theo t·ª´ kh√≥a th√†nh vƒÉn b·∫£n\nconst posts = items[0].json;\nlet message = `üë®‚Äçüè´ *B√ÄI ƒêƒÇNG CHUY√äN GIA V·ªÄ "${items[0].json.keyword}"*\n\n`;\n\nif (posts.length === 0) {\n  message += 'Kh√¥ng t√¨m th·∫•y b√†i ƒëƒÉng chuy√™n gia n√†o ph√π h·ª£p v·ªõi t·ª´ kh√≥a.';\n} else {\n  posts.forEach((post, index) => {\n    message += `*${index + 1}. B√†i ƒëƒÉng*\n`;\n    message += `üìù ${post.text.substring(0, 200)}...\n`;\n    if (post.url) {\n      message += `üîó [Xem tr√™n Facebook](${post.url})\n`;\n    }\n    message += `üëç L∆∞·ª£t th√≠ch: ${post.likes}\n`;\n    message += `üí¨ B√¨nh lu·∫≠n: ${post.comments}\n`;\n    if (post.score) {\n      message += `üìä ƒêi·ªÉm: ${post.score.toFixed(2)}\n`;\n    }\n    if (post.reason) {\n      message += `üí° ${post.reason}\n`;\n    }\n    message += '\n';\n  });\n}\n\nreturn [{\n  json: {\n    chatId: items[0].json.chatId || items[0].json.message.chat.id,\n    message: message\n  }\n}];"
      },
      "name": "Format Expert Posts By Keyword",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1840,
        500
      ]
    },
    {
      "parameters": {
        "functionCode": "// Format b√†i ƒëƒÉng chuy√™n gia theo n·ªôi dung th√†nh vƒÉn b·∫£n\nconst posts = items[0].json;\nlet message = `üë®‚Äçüè´ *B√ÄI ƒêƒÇNG CHUY√äN GIA T∆Ø∆†NG T·ª∞ V·ªöI N·ªòI DUNG*\n\n`;\n\nif (posts.length === 0) {\n  message += 'Kh√¥ng t√¨m th·∫•y b√†i ƒëƒÉng chuy√™n gia n√†o t∆∞∆°ng t·ª± v·ªõi n·ªôi dung.';\n} else {\n  message += `*N·ªôi dung g·ªëc:* ${items[0].json.content.substring(0, 100)}...\n\n`;\n  if (posts[0].translated_content) {\n    message += `*B·∫£n d·ªãch:* ${posts[0].translated_content.substring(0, 100)}...\n\n`;\n  }\n  \n  posts.forEach((post, index) => {\n    message += `*${index + 1}. B√†i ƒëƒÉng*\n`;\n    message += `üìù ${post.text.substring(0, 200)}...\n`;\n    if (post.url) {\n      message += `üîó [Xem tr√™n Facebook](${post.url})\n`;\n    }\n    message += `üëç L∆∞·ª£t th√≠ch: ${post.likes}\n`;\n    message += `üí¨ B√¨nh lu·∫≠n: ${post.comments}\n`;\n    if (post.similarity) {\n      message += `üìä ƒê·ªô t∆∞∆°ng ƒë·ªìng: ${(post.similarity * 100).toFixed(2)}%\n`;\n    }\n    message += '\n';\n  });\n}\n\nreturn [{\n  json: {\n    chatId: items[0].json.chatId || items[0].json.message.chat.id,\n    message: message\n  }\n}];"
      },
      "name": "Format Expert Posts By Content",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1840,
        600
      ]
    },
    {
      "parameters": {
        "authentication": "none",
        "operation": "sendText",
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "disable_web_page_preview": true
        }
      },
      "name": "Send Formatted Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        2060,
        400
      ]
    },
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        }
      },
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        240,
        100
      ]
    },
    {
      "parameters": {
        "url": "http://localhost:8001/health",
        "options": {}
      },
      "name": "Health Check",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        460,
        100
      ]
    },
    {
      "parameters": {
        "botToken": "={{ $env.TELEGRAM_BOT_TOKEN }}",
        "updates": [
          "message"
        ],
        "options": {}
      },
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        240,
        500
      ]
    }
  ],
  "connections": {
    "Start Command": {
      "main": [
        [
          {
            "node": "Telegram: Send Welcome Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "News Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "News Command": {
      "main": [
        [
          {
            "node": "Get Top News",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "News Keyword Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "News Keyword Command": {
      "main": [
        [
          {
            "node": "Extract News Keyword",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Expert Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expert Command": {
      "main": [
        [
          {
            "node": "Extract Expert Keyword",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Expert Content Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expert Content Command": {
      "main": [
        [
          {
            "node": "Extract Expert Content",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Extract News Keyword": {
      "main": [
        [
          {
            "node": "Check News Keyword Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Expert Keyword": {
      "main": [
        [
          {
            "node": "Check Expert Keyword Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Expert Content": {
      "main": [
        [
          {
            "node": "Check Expert Content Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check News Keyword Error": {
      "main": [
        [
          {
            "node": "Send Error Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get News By Keyword",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Expert Keyword Error": {
      "main": [
        [
          {
            "node": "Send Error Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Expert Posts By Keyword",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Expert Content Error": {
      "main": [
        [
          {
            "node": "Send Error Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Expert Posts By Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Top News": {
      "main": [
        [
          {
            "node": "Format News",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get News By Keyword": {
      "main": [
        [
          {
            "node": "Format News By Keyword",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Expert Posts By Keyword": {
      "main": [
        [
          {
            "node": "Format Expert Posts By Keyword",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Expert Posts By Content": {
      "main": [
        [
          {
            "node": "Format Expert Posts By Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format News": {
      "main": [
        [
          {
            "node": "Send Formatted Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format News By Keyword": {
      "main": [
        [
          {
            "node": "Send Formatted Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Expert Posts By Keyword": {
      "main": [
        [
          {
            "node": "Send Formatted Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Expert Posts By Content": {
      "main": [
        [
          {
            "node": "Send Formatted Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Start Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}